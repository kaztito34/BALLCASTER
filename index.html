<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>🌀 Maze Runner — Farcaster Mini App</title>
<style>
  :root { color-scheme: dark; }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    background: linear-gradient(135deg, #0a0e13 0%, #1a1f2e 100%);
    color: #e7ecf0;
    font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100dvh;
    padding: 20px;
  }
  .wrap { width: min(900px, 96vw); position: relative; }
  .card { background: #12171b; border: 1px solid #1f2a32; border-radius: 14px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
  .overlay { position: fixed; inset: 0; display: grid; place-items: center; background: rgba(8,11,14,.85); backdrop-filter: blur(4px); padding: 16px; z-index: 100; }
  .hidden { display: none !important; }
  h1 { font-size: 28px; font-weight: 900; margin-bottom: 12px; text-shadow: 0 2px 10px rgba(56,189,248,0.5); }
  .btn-primary {
    padding: 14px 28px;
    background: linear-gradient(135deg, #ff8c42, #ff6b1a);
    color: #fff;
    border: none;
    border-radius: 12px;
    font-weight: 900;
    font-size: 16px;
    cursor: pointer;
    box-shadow: 0 6px 20px rgba(255,107,26,0.4);
    transition: all 0.2s;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .btn-primary:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(255,107,26,0.5);
  }
  .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }
  .btn-secondary { padding: 12px 24px; background: linear-gradient(135deg, #38bdf8, #34d399); color: #0a1929; border: none; border-radius: 10px; font-weight: 900; font-size: 14px; cursor: pointer; box-shadow: 0 4px 15px rgba(56,189,248,0.3); transition: all 0.2s; letter-spacing: 0.5px; text-transform: uppercase; }
  .btn-reset { background: linear-gradient(135deg, #f43f5e, #f59e0b); }
  #canvas {
    background: #0d1117;
    border: 3px solid #1f2937;
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    max-width: 100%;
    display: block;
    margin: 20px auto;
    touch-action: none;
  }
  #controls { width: 100%; margin-top: 15px; display: flex; flex-direction: column; gap: 15px; }
  .control-row { background: rgba(15,23,42,0.8); border: 2px solid #1e293b; border-radius: 12px; padding: 15px; display: flex; align-items: center; justify-content: space-between; gap: 15px; flex-wrap: wrap; }
  .control-group { display: flex; align-items: center; gap: 10px; }
  label { font-weight: 700; font-size: 14px; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; }
  .info { color: #94a3b8; font-size: 13px; }
  #status { margin-top: 15px; font-size: 13px; line-height: 1.5; background: #0f151a; border: 1px solid #1f2a32; border-radius: 10px; padding: 12px; }
  #status b { color: #cde7d8; } #status .ok { color: #4ade80; } #status .warn { color: #fbbf24; } #status .err { color: #f87171; } #status a { color: #86c6ff; text-decoration: none; }
  #play-again { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); padding: 16px 32px; background: linear-gradient(135deg, #ff8c42, #ff6b1a); color: #fff; border: none; border-radius: 12px; font-weight: 900; font-size: 18px; cursor: pointer; box-shadow: 0 10px 40px rgba(255,107,26,0.5); z-index: 50; }
  @keyframes bounce { 0%, 100% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; } 50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; } }
</style>
</head>
<body>
<div class="wrap">
  <!-- Intro Overlay -->
  <div id="intro-overlay" class="overlay">
    <div class="card" role="dialog" aria-modal="true">
      <h1>🌀 Play Maze Runner</h1>
      <div style="display: flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap;">
        <button id="play" class="btn-primary">💰 Pay & Play</button>
      </div>
      <div id="status" class="hidden"></div>
    </div>
  </div>

  <canvas id="canvas" width="900" height="600"></canvas>

  <div id="controls">
    <div class="control-row">
      <div class="control-group">
        <button id="resetBtn" class="btn-secondary btn-reset">🔄 RESET</button>
      </div>
      <div class="control-group">
        <span class="info">Steps:</span>
        <span class="score-display" id="stepDisplay">0</span>
        <span class="info">Goal:</span>
        <span class="score-display" id="goalDisplay">0</span>
      </div>
    </div>
  </div>

  <button id="play-again" class="hidden">💰 Pay & Play Again</button>
</div>

<script type="module">
import { sdk } from 'https://esm.sh/@farcaster/miniapp-sdk';
sdk.actions.ready();

/* ===== CONFIG ===== */
const USE_BASE_SEPOLIA = false;
const RECIPIENT = "0xc4EB7B433f9911a15c18729D8BE5e5fDa1187E1a";
const AMOUNT_ETH = "0.00001";

const BASE_MAINNET = { chainId: "0x2105",  explorer: "https://basescan.org/tx/" };
const BASE_SEPOLIA = { chainId: "0x14a34", explorer: "https://sepolia.basescan.org/tx/" };
const TARGET = USE_BASE_SEPOLIA ? BASE_SEPOLIA : BASE_MAINNET;

/* ===== DOM ===== */
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const statusEl = document.getElementById('status');
const playBtn = document.getElementById('play');
const playAgainBtn = document.getElementById('play-again');
const resetBtn = document.getElementById('resetBtn');
const stepDisplay = document.getElementById('stepDisplay');
const goalDisplay = document.getElementById('goalDisplay');

const showStatus = () => statusEl.classList.remove('hidden');
const addLine = html => { showStatus(); statusEl.insertAdjacentHTML('beforeend', `<div>${html}</div>`); };
const clearStatus = () => statusEl.innerHTML = '';
const disable = (el, yes=true) => { if (el) el.disabled = yes; };

/* ===== Wallet Helpers ===== */
function parseEther(x) {
  const [w, f=""] = String(x).split('.');
  const frac = (f + '0'.repeat(18)).slice(0, 18);
  return '0x' + (BigInt(w) * 10n**18n + BigInt(frac)).toString(16);
}

async function getProvider() {
  try { const p = await sdk.wallet.getEthereumProvider(); if (p) return p; } catch {}
  return window.ethereum ?? null;
}

async function ensureChain(provider, chainId) {
  const current = (await provider.request({ method: 'eth_chainId' }))?.toLowerCase();
  if (current === chainId.toLowerCase()) return;
  try { await provider.request({ method: 'wallet_switchEthereumChain', params: [{ chainId }] }); } 
  catch (e) { 
    if (e?.code === 4902) { 
      await provider.request({ method: 'wallet_addEthereumChain', params: [{ chainId }] }); 
      await provider.request({ method: 'wallet_switchEthereumChain', params: [{ chainId }] }); 
    } else { throw e; }
  }
}

async function requiredPayment() {
  clearStatus();
  addLine(`<b>Step 1:</b> Locating wallet provider…`);
  const provider = await getProvider();
  if (!provider) { addLine(`<span class="err">No wallet available.</span>`); throw new Error('NO_PROVIDER'); }
  addLine(`<span class="ok">Provider ready.</span>`);
  addLine(`<b>Step 2:</b> Requesting accounts…`);
  const [from] = await provider.request({ method: 'eth_requestAccounts' });
  addLine(`<span class="ok">Account: ${from.slice(0,6)}…${from.slice(-4)}</span>`);
  addLine(`<b>Step 3:</b> Switching to Base${USE_BASE_SEPOLIA?' Sepolia':''}…`);
  await ensureChain(provider, TARGET.chainId);
  addLine(`<span class="ok">On Base${USE_BASE_SEPOLIA?' Sepolia':''}.</span>`);
  addLine(`<b>Step 4:</b> Sending ${AMOUNT_ETH} ETH to ${RECIPIENT.slice(0,6)}…${RECIPIENT.slice(-4)}…`);
  const hash = await provider.request({ method: 'eth_sendTransaction', params: [{ from, to: RECIPIENT, value: parseEther(AMOUNT_ETH) }] });
  addLine(`<span class="ok">TX sent.</span> <a target="_blank" rel="noopener" href="${TARGET.explorer}${hash}">View on Basescan</a>`);
  return hash;
}

async function payThen(action, triggerBtn) {
  try { disable(triggerBtn,true); await requiredPayment(); await action(); } 
  catch (e) { console.warn(e); addLine(`<span class="warn">Payment required. Please try again.</span>`); } 
  finally { disable(triggerBtn,false); }
}

/* ===== Maze Game State ===== */
const TILE = 40;
const ROWS = Math.floor(canvas.height / TILE);
const COLS = Math.floor(canvas.width / TILE);

let gameState = {
  maze: [],
  player: { x: 0, y: 0 },
  goal: { x: COLS-1, y: ROWS-1 },
  steps: 0,
  gameActive: false
};

/* ===== Maze Generation ===== */
function generateMaze() {
  gameState.maze = Array.from({ length: ROWS }, () => Array(COLS).fill(1));
  for(let r=1;r<ROWS-1;r++) for(let c=1;c<COLS-1;c++) gameState.maze[r][c] = Math.random()<0.7?0:1;
  gameState.player = { x: 0, y: 0 };
  gameState.goal = { x: COLS-1, y: ROWS-1 };
  gameState.steps = 0;
}

/* ===== Draw Maze ===== */
function drawMaze() {
  ctx.fillStyle = '#0d1117';
  ctx.fillRect(0,0,canvas.width,canvas.height);
  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      if(gameState.maze[r][c]===1){
        ctx.fillStyle = '#1f2937';
        ctx.fillRect(c*TILE, r*TILE, TILE, TILE);
      }
    }
  }
  // Player
  ctx.fillStyle = '#34d399';
  ctx.fillRect(gameState.player.x*TILE+5, gameState.player.y*TILE+5, TILE-10, TILE-10);
  // Goal
  ctx.fillStyle = '#fbbf24';
  ctx.fillRect(gameState.goal.x*TILE+5, gameState.goal.y*TILE+5, TILE-10, TILE-10);
  stepDisplay.textContent = gameState.steps;
  goalDisplay.textContent = `${gameState.goal.x},${gameState.goal.y}`;
}

/* ===== Player Movement ===== */
function movePlayer(dx,dy){
  if(!gameState.gameActive) return;
  const nx = gameState.player.x+dx;
  const ny = gameState.player.y+dy;
  if(nx>=0 && nx<COLS && ny>=0 && ny<ROWS && gameState.maze[ny][nx]===0){
    gameState.player.x = nx;
    gameState.player.y = ny;
    gameState.steps++;
    drawMaze();
    checkWin();
  }
}

function checkWin(){
  if(gameState.player.x===gameState.goal.x && gameState.player.y===gameState.goal.y){
    gameState.gameActive = false;
    setTimeout(() => showMessage('🏆 You Escaped the Maze!', '#fbbf24'), 100);
    playAgainBtn.classList.remove('hidden');
  }
}

/* ===== Message Overlay ===== */
function showMessage(text,color){
  const msgDiv = document.createElement('div');
  msgDiv.textContent = text;
  msgDiv.style.cssText=`position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);font-size:48px;font-weight:900;color:${color};text-shadow:0 0 30px ${color};pointer-events:none;z-index:1000;animation:bounce 1s ease-out;`;
  document.body.appendChild(msgDiv);
  setTimeout(()=>msgDiv.remove(),1500);
}

/* ===== Event Listeners ===== */
window.addEventListener('keydown', e => {
  switch(e.key){
    case 'ArrowUp': movePlayer(0,-1); break;
    case 'ArrowDown': movePlayer(0,1); break;
    case 'ArrowLeft': movePlayer(-1,0); break;
    case 'ArrowRight': movePlayer(1,0); break;
  }
});

resetBtn.addEventListener('click', ()=>{ generateMaze(); drawMaze(); });

playBtn.addEventListener('click', (e)=>{
  e.preventDefault();
  payThen(()=>{ 
    document.getElementById('intro-overlay').classList.add('hidden');
    gameState.gameActive = true;
    generateMaze(); drawMaze();
  }, playBtn);
});

playAgainBtn.addEventListener('click', (e)=>{
  e.preventDefault();
  payThen(()=>{
    playAgainBtn.classList.add('hidden');
    gameState.gameActive=true;
    generateMaze(); drawMaze();
  }, playAgainBtn);
});

/* ===== Start Loop ===== */
drawMaze();
</script>
</body>
</html>
